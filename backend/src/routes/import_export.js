import { Router } from 'express'; import multer from 'multer'; import { pool } from '../db.js'; import { auth } from '../middleware/auth.js'; const router=Router(); const upload=multer({ storage: multer.memoryStorage(), limits: { fileSize: 5 * 1024 * 1024 } });
router.post('/clients/import', auth('ADMIN'), upload.single('file'), async (req,res)=>{ if(!req.file) return res.status(400).json({ error:'Arquivo CSV nÃ£o enviado' }); const csvStr=req.file.buffer.toString('utf8').split('\ufeff').join(''); const lines=csvStr.split(/\r?\n/).filter(l=>l.trim().length); let inserted=0, skipped=0; for(let i=1;i<lines.length;i++){ const cols=lines[i].split(';').map(s=>s.trim()); const [name, cpf, phone, email, store_id] = cols; if(!name){ skipped++; continue; } try{ await pool.query('INSERT INTO clients (name, cpf, phone, email, store_id) VALUES ($1,$2,$3,$4,$5) ON CONFLICT DO NOTHING', [name||null, cpf||null, phone||null, email||null, store_id?Number(store_id):null]); inserted++; } catch(e){ skipped++; } } res.json({ ok:true, inserted, skipped }) });
router.get('/clients/export', auth(), async (_req,res)=>{ const { rows } = await pool.query('SELECT id, name, cpf, phone, email, store_id, created_at FROM clients ORDER BY id'); const header='id;name;cpf;phone;email;store_id;created_at\n'; const body=rows.map(r=>[r.id,r.name,r.cpf || '',r.phone || '',r.email || '',r.store_id || '',r.created_at].join(';')).join('\n'); res.setHeader('Content-Type','text/csv; charset=utf-8'); res.setHeader('Content-Disposition','attachment; filename="clientes.csv"'); res.send('\ufeff'+header+body) });
export default router;
